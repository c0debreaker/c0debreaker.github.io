<!DOCTYPE html>

<head>
  <meta charset="utf-8" />
  <title>AngularJS and HTML5 Audio</title>
  <base href="/">

  <style>
  body {
    background: black;
  }
  div#mp3_player {
    width: 500px;
    height: 60px;
    background: #000;
    padding: 5px;
    margin: 50px auto;
  }
    
  div#mp3_player > canvas {
    width: 500px;
    height: 150px;
    background: black;
    float: left;
  }
  </style>
  <script data-require="angular.js@1.3.x" src="https://code.angularjs.org/1.3.15/angular.js" data-semver="1.3.15"></script>
  <script>

    if (! window.AudioContext) {
        if (! window.webkitAudioContext) {
          alert('You might be viewing this on your mobile. Unfortunately, AudioContext is not supported on this browser');
        }
        window.AudioContext = window.webkitAudioContext;
    }


  var app = angular.module('angular-html5-audio', []);

  app.controller('MainCtrl', function($scope, $sce, $rootScope) {

    $scope.url = "daughtry.m4a";

    window.requestAnimFrame = function(){
        return (
            window.requestAnimationFrame       || 
            window.webkitRequestAnimationFrame || 
            window.mozRequestAnimationFrame    || 
            window.oRequestAnimationFrame      || 
            window.msRequestAnimationFrame     || 
            function(/* function */ callback){
                window.setTimeout(callback, 1000 / 60);
            }
        );
    }();

    $scope.playAudio = function() {
      return $sce.trustAsResourceUrl($scope.url);
    };

    $scope.initMp3Player = function() {
      $scope.myAudio = document.querySelector('audio');

      window.AudioContext = AudioContext || window.webkitAudioContext;
      $scope.context = new AudioContext();

      $scope.analyser = $scope.context.createAnalyser();
      $scope.source = $scope.context.createMediaElementSource($scope.myAudio);

      $scope.fbc_array = new Uint8Array($scope.analyser.frequencyBinCount);
      $scope.analyser.smoothingTimeConstant = 0.8;
      // $scope.analyser.fftSize = 512;

      $scope.canvas = document.getElementById('analyser_render');
      $scope.ctx = $scope.canvas.getContext('2d');
      $rootScope.$emit('startAudio', { message: 'start audio' });
      
    };

    $rootScope.$on('startAudio', function (event, args) {
      $scope.source.connect($scope.analyser);
      $scope.source.connect($scope.context.destination);
      $scope.analyser.connect($scope.context.destination);
      frameLooper();
    });

    function frameLooper() {
      requestAnimFrame(frameLooper);
      renderSpectrum();
    }

    function renderSpectrum() {
      $scope.analyser.getByteFrequencyData($scope.fbc_array);
      $scope.ctx.clearRect(0, 0, $scope.canvas.width, $scope.canvas.height); // Clear the canvas
      $scope.ctx.fillStyle = '#00CCFF'; // Color of the bars
      bars = 1024;
      for (var i = 0; i < bars; i++) {
        bar_x = i * 2;
        bar_width = 1;
        bar_height = -($scope.fbc_array[i] / 2);
        var spectrumColors = $scope.ctx.createLinearGradient(0,0,0,200);
        spectrumColors.addColorStop(0,"black");
        spectrumColors.addColorStop(0.5, "#FFA000");
        spectrumColors.addColorStop(0.3, "yellow");
        spectrumColors.addColorStop(0.8, "red");
        spectrumColors.addColorStop(1, "white");
        $scope.ctx.fillStyle = spectrumColors;
        $scope.ctx.fillRect(bar_x, $scope.canvas.height, bar_width, bar_height);
      }
    }

    window.addEventListener('load', $scope.initMp3Player, false);

  });
  </script>
</head>
<html ng-app="angular-html5-audio">
  <body ng-controller="MainCtrl">
    <div id="mp3_player">
      <audio controls autoplay loop ng-src="{{playAudio()}}"></audio>
      <canvas id="analyser_render"></canvas>
    </div>
  </body>
</html>
